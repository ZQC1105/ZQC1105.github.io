# ğŸ¯ å®Œå…¨æ­£ç¡®ï¼L2æµ‹è¯•é¡¹ç›®åº”è¯¥ç›´æ¥ä½¿ç”¨HttpClient

ä½ ç†è§£å¾—éå¸¸å‡†ç¡®ï¼è®©æˆ‘è¯¦ç»†è¯´æ˜å¦‚ä½•æ­£ç¡®æ„å»ºL2æµ‹è¯•é¡¹ç›®ã€‚

## ğŸ“ **L2æµ‹è¯•é¡¹ç›®ç»“æ„**

```
Tests/
â”œâ”€â”€ Unit.Tests/                    # L0 å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ Services/                 # ä¸ä¾èµ–å¤–éƒ¨
â”‚
â”œâ”€â”€ Integration.Tests/            # L1 é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ Uses WebApplicationFactory
â”‚
â”œâ”€â”€ Contract.Tests/              # âœ… L2 å¥‘çº¦æµ‹è¯•é¡¹ç›®
â”‚   â”œâ”€â”€ ApiClients/              # å°è£…HttpClient
â”‚   â”œâ”€â”€ Contracts/               # OpenAPI/Pactå¥‘çº¦æ–‡ä»¶
â”‚   â”œâ”€â”€ TestData/                # æµ‹è¯•æ•°æ®ç®¡ç†
â”‚   â”œâ”€â”€ Validators/              # å¥‘çº¦éªŒè¯å™¨
â”‚   â””â”€â”€ UsersApiTests.cs         # ä½¿ç”¨çº¯HttpClient
â”‚
â””â”€â”€ E2E.Tests/                   # L3 ç«¯åˆ°ç«¯æµ‹è¯•
```

---

## ğŸš€ **æ­£ç¡®çš„L2æµ‹è¯•é¡¹ç›®é…ç½®**

### **1. åˆ›å»ºç‹¬ç«‹çš„L2æµ‹è¯•é¡¹ç›®**
```xml
<!-- Contract.Tests.csproj -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <IsTestProject>true</IsTestProject>
    <IsPackable>false</IsPackable>
    <RootNamespace>Contract.Tests</RootNamespace>
  </PropertyGroup>

  <ItemGroup>
    <!-- æµ‹è¯•æ¡†æ¶ -->
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.8.0" />
    <PackageReference Include="xunit" Version="2.6.2" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.5.5" />
    
    <!-- HTTPå®¢æˆ·ç«¯ -->
    <PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />
    
    <!-- æ–­è¨€å’Œæµ‹è¯•è¾…åŠ© -->
    <PackageReference Include="FluentAssertions" Version="6.12.0" />
    <PackageReference Include="Bogus" Version="35.5.0" /> <!-- å‡æ•°æ®ç”Ÿæˆ -->
    
    <!-- JSONå¤„ç† -->
    <PackageReference Include="System.Text.Json" Version="8.0.0" />
    
    <!-- å¥‘çº¦éªŒè¯ -->
    <PackageReference Include="JsonSchema.Net" Version="4.0.5" />
    <PackageReference Include="NSwag.ApiDescription.Client" Version="13.20.0" />
    
    <!-- é…ç½®ç®¡ç† -->
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="8.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <None Update="appsettings.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="openapi-spec.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
    <None Update="test-data/*.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>
</Project>
```

### **2. é…ç½®æ–‡ä»¶**
```json
// appsettings.json
{
  "ApiEndpoints": {
    "Staging": "https://api-staging.example.com",
    "UAT": "https://api-uat.example.com",
    "Production": "https://api.example.com"
  },
  "Authentication": {
    "ApiKey": "sk_test_123456789",
    "ClientId": "test-client",
    "ClientSecret": "test-secret"
  },
  "TestSettings": {
    "DefaultEnvironment": "Staging",
    "EnableDataCleanup": true,
    "RequestTimeoutSeconds": 30,
    "MaxRetryAttempts": 3
  }
}
```

### **3. ç¯å¢ƒé€‰æ‹©å™¨**
```csharp
// TestEnvironment.cs
public static class TestEnvironment
{
    private static IConfiguration _configuration;
    
    public static string BaseUrl => GetBaseUrl();
    public static string ApiKey => GetApiKey();
    public static bool EnableDataCleanup => GetEnableDataCleanup();
    
    static TestEnvironment()
    {
        var environment = Environment.GetEnvironmentVariable("TEST_ENVIRONMENT") 
                         ?? "Staging";
        
        _configuration = new ConfigurationBuilder()
            .SetBasePath(Directory.GetCurrentDirectory())
            .AddJsonFile("appsettings.json", optional: false)
            .AddJsonFile($"appsettings.{environment}.json", optional: true)
            .AddEnvironmentVariables()
            .Build();
    }
    
    private static string GetBaseUrl()
    {
        var environment = Environment.GetEnvironmentVariable("TEST_ENVIRONMENT") 
                         ?? "Staging";
        
        var baseUrl = _configuration[$"ApiEndpoints:{environment}"];
        
        if (string.IsNullOrEmpty(baseUrl))
        {
            throw new InvalidOperationException(
                $"æœªæ‰¾åˆ°ç¯å¢ƒ {environment} çš„APIåœ°å€é…ç½®");
        }
        
        return baseUrl;
    }
    
    public static HttpClient CreateClient()
    {
        var client = new HttpClient
        {
            BaseAddress = new Uri(BaseUrl),
            Timeout = TimeSpan.FromSeconds(
                _configuration.GetValue<int>("TestSettings:RequestTimeoutSeconds"))
        };
        
        // æ·»åŠ è®¤è¯å¤´
        if (!string.IsNullOrEmpty(ApiKey))
        {
            client.DefaultRequestHeaders.Add("X-API-Key", ApiKey);
        }
        
        // æ·»åŠ æµ‹è¯•æ ‡è¯†å¤´
        client.DefaultRequestHeaders.Add("X-Test-Request", "true");
        client.DefaultRequestHeaders.Add("X-Test-Run-Id", 
            Guid.NewGuid().ToString());
        
        return client;
    }
}
```

---

## ğŸ’» **æ ¸å¿ƒL2æµ‹è¯•å®ç°**

### **1. åŸºç¡€æµ‹è¯•ç±»ï¼ˆæ— WebApplicationFactoryï¼ï¼‰**
```csharp
// ApiContractTestBase.cs
public abstract class ApiContractTestBase : IAsyncLifetime
{
    protected HttpClient Client { get; private set; }
    protected TestDataManager TestData { get; private set; }
    protected OpenApiValidator Validator { get; private set; }
    
    public async Task InitializeAsync()
    {
        // âœ… å…³é”®ï¼šåˆ›å»ºHttpClientï¼Œä¸åˆ›å»ºWebApplicationFactoryï¼
        Client = TestEnvironment.CreateClient();
        
        // éªŒè¯æœåŠ¡æ˜¯å¦å¯ç”¨
        await EnsureServiceIsAvailable();
        
        // åˆå§‹åŒ–å·¥å…·
        TestData = new TestDataManager(Client);
        Validator = await OpenApiValidator.CreateAsync(Client);
    }
    
    private async Task EnsureServiceIsAvailable()
    {
        var maxRetries = TestEnvironment.MaxRetryAttempts;
        
        for (int i = 0; i < maxRetries; i++)
        {
            try
            {
                var healthResponse = await Client.GetAsync("/health");
                if (healthResponse.IsSuccessStatusCode)
                {
                    return; // æœåŠ¡å¯ç”¨
                }
            }
            catch (HttpRequestException)
            {
                // ç­‰å¾…åé‡è¯•
                if (i < maxRetries - 1)
                {
                    await Task.Delay(TimeSpan.FromSeconds(2 * (i + 1)));
                }
            }
        }
        
        throw new InvalidOperationException(
            $"æœåŠ¡ {Client.BaseAddress} åœ¨ {maxRetries} æ¬¡é‡è¯•åä»ä¸å¯ç”¨");
    }
    
    public async Task DisposeAsync()
    {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        if (TestEnvironment.EnableDataCleanup)
        {
            await TestData.CleanupAllTestDataAsync();
        }
        
        Client?.Dispose();
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šéªŒè¯å“åº”å¥‘çº¦
    protected async Task AssertResponseConformsToContract(
        HttpResponseMessage response,
        string endpoint,
        string httpMethod,
        int expectedStatusCode)
    {
        // éªŒè¯çŠ¶æ€ç 
        response.StatusCode.Should().Be((HttpStatusCode)expectedStatusCode,
            $"API {endpoint} åº”è¿”å›çŠ¶æ€ç  {expectedStatusCode}");
        
        // éªŒè¯å¥‘çº¦
        var validationResult = await Validator.ValidateResponseAsync(
            endpoint, httpMethod, response);
        
        validationResult.IsValid.Should().BeTrue(
            $"APIå“åº”ä¸ç¬¦åˆå¥‘çº¦: {string.Join(", ", validationResult.Errors)}");
    }
}
```

### **2. å…·ä½“çš„APIå¥‘çº¦æµ‹è¯•**
```csharp
// UsersApiContractTests.cs
public class UsersApiContractTests : ApiContractTestBase
{
    private readonly Faker<UserRequest> _userFaker;
    
    public UsersApiContractTests()
    {
        _userFaker = new Faker<UserRequest>()
            .RuleFor(u => u.Email, f => f.Internet.Email())
            .RuleFor(u => u.Name, f => f.Name.FullName())
            .RuleFor(u => u.Password, f => f.Internet.Password(10));
    }
    
    [Fact]
    public async Task CreateUser_ValidRequest_Returns201AndConformsToContract()
    {
        // Arrange
        var userRequest = _userFaker.Generate();
        
        // Act
        var response = await Client.PostAsJsonAsync("/api/v1/users", userRequest);
        
        // Assert
        await AssertResponseConformsToContract(response, 
            "/api/v1/users", "POST", 201);
        
        // é¢å¤–éªŒè¯ï¼šå“åº”ä½“ä¸­çš„ä¸šåŠ¡è§„åˆ™
        var userResponse = await response.Content.ReadFromJsonAsync<UserResponse>();
        userResponse.Should().NotBeNull();
        userResponse.Id.Should().BeGreaterThan(0);
        userResponse.Email.Should().Be(userRequest.Email);
        userResponse.Name.Should().Be(userRequest.Name);
        userResponse.CreatedAt.Should().BeCloseTo(DateTime.UtcNow, TimeSpan.FromMinutes(1));
        
        // éªŒè¯Locationå¤´
        response.Headers.Location.Should().NotBeNull();
        response.Headers.Location.ToString().Should().Contain($"/api/v1/users/{userResponse.Id}");
    }
    
    [Theory]
    [InlineData(null, "test@example.com", "password123", "Name")]
    [InlineData("John Doe", null, "password123", "Email")]
    [InlineData("John Doe", "invalid-email", "password123", "valid email")]
    [InlineData("John Doe", "test@example.com", "123", "at least 6")]
    public async Task CreateUser_InvalidRequest_Returns400WithCorrectError(
        string name, string email, string password, string expectedError)
    {
        // Arrange
        var userRequest = new { name, email, password };
        
        // Act
        var response = await Client.PostAsJsonAsync("/api/v1/users", userRequest);
        
        // Assert
        await AssertResponseConformsToContract(response, 
            "/api/v1/users", "POST", 400);
        
        var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
        errorResponse.Should().NotBeNull();
        errorResponse.Code.Should().Be("VALIDATION_ERROR");
        errorResponse.Message.Should().Contain(expectedError, 
            StringComparison.OrdinalIgnoreCase);
    }
    
    [Fact]
    public async Task GetUser_ExistingUser_Returns200AndConformsToContract()
    {
        // Arrange - åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        var userId = await TestData.CreateTestUserAsync();
        
        try
        {
            // Act
            var response = await Client.GetAsync($"/api/v1/users/{userId}");
            
            // Assert
            await AssertResponseConformsToContract(response, 
                "/api/v1/users/{id}", "GET", 200);
            
            var user = await response.Content.ReadFromJsonAsync<UserResponse>();
            user.Should().NotBeNull();
            user.Id.Should().Be(userId);
        }
        finally
        {
            // æ¸…ç†
            await TestData.DeleteTestUserAsync(userId);
        }
    }
    
    [Fact]
    public async Task UpdateUser_ValidRequest_Returns200AndConformsToContract()
    {
        // Arrange
        var userId = await TestData.CreateTestUserAsync();
        var updateRequest = new { Name = "Updated Name" };
        
        try
        {
            // Act
            var response = await Client.PatchAsJsonAsync(
                $"/api/v1/users/{userId}", updateRequest);
            
            // Assert
            await AssertResponseConformsToContract(response, 
                "/api/v1/users/{id}", "PATCH", 200);
            
            // éªŒè¯æ›´æ–°ç”Ÿæ•ˆ
            var getResponse = await Client.GetAsync($"/api/v1/users/{userId}");
            var updatedUser = await getResponse.Content.ReadFromJsonAsync<UserResponse>();
            updatedUser.Name.Should().Be("Updated Name");
        }
        finally
        {
            await TestData.DeleteTestUserAsync(userId);
        }
    }
}
```

### **3. å¥‘çº¦éªŒè¯å™¨**
```csharp
// OpenApiValidator.cs
public class OpenApiValidator
{
    private readonly OpenApiDocument _openApiDocument;
    
    public static async Task<OpenApiValidator> CreateAsync(HttpClient client)
    {
        // ä»æœåŠ¡è·å–OpenAPIæ–‡æ¡£
        var response = await client.GetAsync("/swagger/v1/swagger.json");
        response.EnsureSuccessStatusCode();
        
        var json = await response.Content.ReadAsStringAsync();
        var document = new OpenApiStringReader().Read(json, out var diagnostic);
        
        if (diagnostic.Errors.Any())
        {
            throw new InvalidOperationException(
                $"OpenAPIæ–‡æ¡£è§£æé”™è¯¯: {string.Join(", ", diagnostic.Errors)}");
        }
        
        return new OpenApiValidator(document);
    }
    
    public async Task<ValidationResult> ValidateResponseAsync(
        string endpoint,
        string httpMethod,
        HttpResponseMessage response)
    {
        var result = new ValidationResult();
        
        // æŸ¥æ‰¾ç«¯ç‚¹å®šä¹‰
        var operation = FindOperation(endpoint, httpMethod);
        if (operation == null)
        {
            result.AddError($"ç«¯ç‚¹æœªåœ¨OpenAPIæ–‡æ¡£ä¸­å®šä¹‰: {endpoint} {httpMethod}");
            return result;
        }
        
        // éªŒè¯çŠ¶æ€ç 
        var statusCode = ((int)response.StatusCode).ToString();
        if (!operation.Responses.ContainsKey(statusCode) && 
            !operation.Responses.ContainsKey("default"))
        {
            result.AddError($"çŠ¶æ€ç  {statusCode} æœªåœ¨OpenAPIæ–‡æ¡£ä¸­å®šä¹‰");
        }
        
        // éªŒè¯Content-Type
        var contentType = response.Content.Headers.ContentType?.MediaType;
        if (contentType == "application/json")
        {
            // éªŒè¯JSON Schema
            var schema = GetResponseSchema(operation, statusCode);
            if (schema != null)
            {
                var json = await response.Content.ReadAsStringAsync();
                var schemaErrors = ValidateJsonSchema(json, schema);
                result.AddErrors(schemaErrors);
            }
        }
        
        return result;
    }
}
```

---

## ğŸš€ **è¿è¡ŒL2æµ‹è¯•**

### **å‘½ä»¤è¡Œè¿è¡Œ**
```bash
# è®¾ç½®æµ‹è¯•ç¯å¢ƒå¹¶è¿è¡Œ
export TEST_ENVIRONMENT=Staging
dotnet test ./Contract.Tests --filter "Category=Contract"

# æˆ–æŒ‡å®šç‰¹å®šæµ‹è¯•
dotnet test ./Contract.Tests --filter "UsersApiContractTests"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
dotnet test ./Contract.Tests \
  --logger "trx;LogFileName=TestResults.trx" \
  --logger "html;LogFileName=TestResults.html" \
  --results-directory ./TestResults
```

### **æµ‹è¯•å‰å‡†å¤‡è„šæœ¬**
```bash
#!/bin/bash
# run-contract-tests.sh

echo "=== L2 APIå¥‘çº¦æµ‹è¯• ==="
echo "ç›®æ ‡ç¯å¢ƒ: ${TEST_ENVIRONMENT:-Staging}"
echo "APIåœ°å€: ${API_BASE_URL}"

# ç­‰å¾…æœåŠ¡å°±ç»ª
echo "ç­‰å¾…APIæœåŠ¡å¯åŠ¨..."
for i in {1..30}; do
  if curl -s -f "${API_BASE_URL}/health" > /dev/null; then
    echo "âœ… æœåŠ¡å·²å°±ç»ª"
    break
  fi
  
  echo "ç­‰å¾…ä¸­... ($i/30)"
  sleep 2
  
  if [ $i -eq 30 ]; then
    echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
    exit 1
  fi
done

# è¿è¡Œæµ‹è¯•
echo "å¼€å§‹è¿è¡Œå¥‘çº¦æµ‹è¯•..."
dotnet test ./Contract.Tests \
  --logger "console;verbosity=normal" \
  --verbosity minimal
  
TEST_RESULT=$?

# è¾“å‡ºç»“æœ
if [ $TEST_RESULT -eq 0 ]; then
  echo "ğŸ‰ æ‰€æœ‰å¥‘çº¦æµ‹è¯•é€šè¿‡ï¼"
else
  echo "âŒ å¥‘çº¦æµ‹è¯•å¤±è´¥"
  exit $TEST_RESULT
fi
```

---

## ğŸ“Š **L2 vs L1æµ‹è¯•é¡¹ç›®å¯¹æ¯”**

| å¯¹æ¯”é¡¹       | L1é›†æˆæµ‹è¯•é¡¹ç›®        | L2å¥‘çº¦æµ‹è¯•é¡¹ç›®              |
| ------------ | --------------------- | --------------------------- |
| **é¡¹ç›®å¼•ç”¨** | å¼•ç”¨ä¸»Webé¡¹ç›®         | ä¸å¼•ç”¨ä¸»é¡¹ç›®ï¼Œç‹¬ç«‹          |
| **æŠ€æœ¯ä¾èµ–** | WebApplicationFactory | HttpClient                  |
| **æœåŠ¡çŠ¶æ€** | å†…å­˜ä¸­å¯åŠ¨            | è¿æ¥å·²éƒ¨ç½²æœåŠ¡              |
| **æ•°æ®åº“**   | å†…å­˜æ•°æ®åº“            | çœŸå®æµ‹è¯•ç¯å¢ƒæ•°æ®åº“          |
| **é…ç½®æ–¹å¼** | ä»£ç ä¸­é…ç½®            | appsettings.json + ç¯å¢ƒå˜é‡ |
| **è¿è¡Œå‰æ** | æ— éœ€éƒ¨ç½²              | éœ€è¦æœåŠ¡å·²éƒ¨ç½²              |
| **æµ‹è¯•é€Ÿåº¦** | å¿«ï¼ˆæ¯«ç§’çº§ï¼‰          | æ…¢ï¼ˆç½‘ç»œè¯·æ±‚ï¼‰              |
| **æµ‹è¯•èŒƒå›´** | å•ä¸ªæœåŠ¡å†…éƒ¨          | è·¨ç¯å¢ƒéªŒè¯                  |

---

## ğŸ’¡ **æ€»ç»“ï¼šä½ çš„ç†è§£å®Œå…¨æ­£ç¡®**

**âœ… æ­£ç¡®åšæ³•ï¼š**
```csharp
// L2å¥‘çº¦æµ‹è¯•é¡¹ç›®åº”è¯¥ï¼š
// 1. ä¸å¼•ç”¨ä¸»Webé¡¹ç›®
// 2. ä¸ä½¿ç”¨WebApplicationFactory
// 3. ç›´æ¥ä½¿ç”¨HttpClient
// 4. è¿æ¥å·²éƒ¨ç½²çš„çœŸå®æœåŠ¡
// 5. éªŒè¯APIå¥‘çº¦è€Œéå†…éƒ¨å®ç°

public class L2ContractTest
{
    private readonly HttpClient _client;
    
    public L2ContractTest()
    {
        // âœ… æ­£ç¡®ï¼šåˆ›å»ºHttpClientè¿æ¥å·²éƒ¨ç½²æœåŠ¡
        _client = new HttpClient 
        { 
            BaseAddress = new Uri("https://api-staging.example.com") 
        };
    }
}
```

**âŒ é”™è¯¯åšæ³•ï¼š**
```csharp
public class WrongL2Test : IClassFixture<WebApplicationFactory<Program>>  // âŒ
{
    // è¿™ä¸æ˜¯çœŸæ­£çš„L2æµ‹è¯•ï¼
    // è¿™æ˜¯L1é›†æˆæµ‹è¯•çš„å˜ä½“
}
```

**å…³é”®åŸåˆ™**ï¼š
1. **L2æµ‹è¯•æ˜¯é»‘ç›’æµ‹è¯•** - ä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒå†…éƒ¨å®ç°
2. **L2æµ‹è¯•éªŒè¯å¥‘çº¦** - ç¡®ä¿APIç¬¦åˆæ‰¿è¯ºçš„æ¥å£è§„èŒƒ
3. **L2æµ‹è¯•éœ€è¦çœŸå®ç¯å¢ƒ** - éªŒè¯çš„æ˜¯éƒ¨ç½²åçš„æœåŠ¡
4. **L2æµ‹è¯•æ˜¯ç‹¬ç«‹é¡¹ç›®** - ä¸ä¾èµ–è¢«æµ‹è¯•æœåŠ¡çš„ä»£ç 

æŒ‰ç…§è¿™ä¸ªæ¨¡å¼æ„å»ºçš„L2æµ‹è¯•é¡¹ç›®ï¼Œæ‰èƒ½çœŸæ­£éªŒè¯"å·²éƒ¨ç½²çš„APIæ˜¯å¦ç¬¦åˆå¥‘çº¦"ï¼Œè€Œä¸æ˜¯"ä»£ç å®ç°æ˜¯å¦æ­£ç¡®"ã€‚